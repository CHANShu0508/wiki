<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>串口收发 | Wiki：知识&amp;笔记</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/img/header32.png">
    <meta name="description" content="不再碎片化 | No longer fragmented">
    <meta name="keywords" content="个人技术博客,技术文档,学习,git,github,markdown,嵌入式,STM32,C语言">
    <meta name="theme-color" content="#11a8cd">
    <link rel="preload" href="/assets/css/0.styles.57c10a4d.css" as="style"><link rel="preload" href="/assets/js/app.287ba006.js" as="script"><link rel="preload" href="/assets/js/2.cf4362eb.js" as="script"><link rel="preload" href="/assets/js/34.2357e103.js" as="script"><link rel="prefetch" href="/assets/js/10.ca3f9f94.js"><link rel="prefetch" href="/assets/js/11.b4d1c50f.js"><link rel="prefetch" href="/assets/js/12.cca3ba79.js"><link rel="prefetch" href="/assets/js/13.e1d72f62.js"><link rel="prefetch" href="/assets/js/14.91f2adb6.js"><link rel="prefetch" href="/assets/js/15.a7a70068.js"><link rel="prefetch" href="/assets/js/16.d5be4432.js"><link rel="prefetch" href="/assets/js/17.31ec0952.js"><link rel="prefetch" href="/assets/js/18.8c0f4835.js"><link rel="prefetch" href="/assets/js/19.7cbc9836.js"><link rel="prefetch" href="/assets/js/20.e1ca69ed.js"><link rel="prefetch" href="/assets/js/21.b3b61477.js"><link rel="prefetch" href="/assets/js/22.03aa72ee.js"><link rel="prefetch" href="/assets/js/23.564ba096.js"><link rel="prefetch" href="/assets/js/24.cf195300.js"><link rel="prefetch" href="/assets/js/25.0d959a77.js"><link rel="prefetch" href="/assets/js/26.8f179dd3.js"><link rel="prefetch" href="/assets/js/27.9d4841cf.js"><link rel="prefetch" href="/assets/js/28.5c175096.js"><link rel="prefetch" href="/assets/js/29.2cb763ad.js"><link rel="prefetch" href="/assets/js/3.92b0bd34.js"><link rel="prefetch" href="/assets/js/30.eaf25d81.js"><link rel="prefetch" href="/assets/js/31.7f3c2787.js"><link rel="prefetch" href="/assets/js/32.abd8deb1.js"><link rel="prefetch" href="/assets/js/33.6c0ca3cd.js"><link rel="prefetch" href="/assets/js/35.bedfc4ca.js"><link rel="prefetch" href="/assets/js/36.1fe9624d.js"><link rel="prefetch" href="/assets/js/37.6c24fb08.js"><link rel="prefetch" href="/assets/js/38.f00e5f04.js"><link rel="prefetch" href="/assets/js/39.5064abfe.js"><link rel="prefetch" href="/assets/js/4.9907f1e1.js"><link rel="prefetch" href="/assets/js/40.a7bfeb29.js"><link rel="prefetch" href="/assets/js/41.8cb7036a.js"><link rel="prefetch" href="/assets/js/42.b5ed0c1b.js"><link rel="prefetch" href="/assets/js/43.29bf753c.js"><link rel="prefetch" href="/assets/js/44.a2888a8b.js"><link rel="prefetch" href="/assets/js/45.26d4fffe.js"><link rel="prefetch" href="/assets/js/46.59abb034.js"><link rel="prefetch" href="/assets/js/47.910b85e1.js"><link rel="prefetch" href="/assets/js/48.afbe4f62.js"><link rel="prefetch" href="/assets/js/49.a134584b.js"><link rel="prefetch" href="/assets/js/5.d0ed1372.js"><link rel="prefetch" href="/assets/js/50.3a7461e2.js"><link rel="prefetch" href="/assets/js/51.9575cb04.js"><link rel="prefetch" href="/assets/js/52.5fd5937b.js"><link rel="prefetch" href="/assets/js/53.d9b43790.js"><link rel="prefetch" href="/assets/js/54.4dd21ee3.js"><link rel="prefetch" href="/assets/js/55.6387d56f.js"><link rel="prefetch" href="/assets/js/56.05dd9dca.js"><link rel="prefetch" href="/assets/js/57.06ef5d9e.js"><link rel="prefetch" href="/assets/js/58.22dcffa8.js"><link rel="prefetch" href="/assets/js/59.f6f581db.js"><link rel="prefetch" href="/assets/js/6.e89ddaa7.js"><link rel="prefetch" href="/assets/js/60.608fdff0.js"><link rel="prefetch" href="/assets/js/61.ca910a34.js"><link rel="prefetch" href="/assets/js/62.40a51140.js"><link rel="prefetch" href="/assets/js/63.939ad5ab.js"><link rel="prefetch" href="/assets/js/64.fb28b271.js"><link rel="prefetch" href="/assets/js/65.4d6df1bd.js"><link rel="prefetch" href="/assets/js/66.0063edc7.js"><link rel="prefetch" href="/assets/js/67.bfd086a1.js"><link rel="prefetch" href="/assets/js/7.3cc1b487.js"><link rel="prefetch" href="/assets/js/8.3c2658fb.js"><link rel="prefetch" href="/assets/js/9.e346ca1c.js">
    <link rel="stylesheet" href="/assets/css/0.styles.57c10a4d.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/head.png" alt="Wiki：知识&amp;笔记" class="logo"> <span class="site-name can-hide">Wiki：知识&amp;笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="语言学习" class="dropdown-title"><a href="/languages/" class="link-title">语言学习</a> <span class="title" style="display:none;">语言学习</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>学习笔记</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/javascript/" class="nav-link">《JavaScript教程》笔记</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="基础知识" class="dropdown-title"><a href="/basicknowledge/" class="link-title">基础知识</a> <span class="title" style="display:none;">基础知识</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>嵌入式</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/basicknowledge/stm32/" class="nav-link">STM32</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><a href="/others/" class="link-title">其他</a> <span class="title" style="display:none;">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/others/9a7ee40fc232253e/" class="nav-link">技术文档</a></li></ul></div></div><div class="nav-item"><a href="/archives/" class="nav-link">归档</a></div> <a href="https://github.com/chanshu0508/wikiBase" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="语言学习" class="dropdown-title"><a href="/languages/" class="link-title">语言学习</a> <span class="title" style="display:none;">语言学习</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>学习笔记</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/javascript/" class="nav-link">《JavaScript教程》笔记</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="基础知识" class="dropdown-title"><a href="/basicknowledge/" class="link-title">基础知识</a> <span class="title" style="display:none;">基础知识</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>嵌入式</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/basicknowledge/stm32/" class="nav-link">STM32</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><a href="/others/" class="link-title">其他</a> <span class="title" style="display:none;">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/others/9a7ee40fc232253e/" class="nav-link">技术文档</a></li></ul></div></div><div class="nav-item"><a href="/archives/" class="nav-link">归档</a></div> <a href="https://github.com/chanshu0508/wikiBase" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/pages/a4ea7f/" aria-current="page" class="active sidebar-link">串口收发</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/a4ea7f/#什么是串口" class="sidebar-link">什么是串口</a></li><li class="sidebar-sub-header"><a href="/pages/a4ea7f/#串口的工作" class="sidebar-link">串口的工作</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/a4ea7f/#接收信号的形式" class="sidebar-link">接收信号的形式</a></li><li class="sidebar-sub-header"><a href="/pages/a4ea7f/#波特率" class="sidebar-link">波特率</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/a4ea7f/#硬件层面" class="sidebar-link">硬件层面</a></li><li class="sidebar-sub-header"><a href="/pages/a4ea7f/#实践操作" class="sidebar-link">实践操作</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/a4ea7f/#cubemx" class="sidebar-link">CubeMX</a></li><li class="sidebar-sub-header"><a href="/pages/a4ea7f/#接收中断与空闲中断" class="sidebar-link">接收中断与空闲中断</a></li><li class="sidebar-sub-header"><a href="/pages/a4ea7f/#用到的库函数" class="sidebar-link">用到的库函数</a></li><li class="sidebar-sub-header"><a href="/pages/a4ea7f/#接收中断程序" class="sidebar-link">接收中断程序</a></li><li class="sidebar-sub-header"><a href="/pages/a4ea7f/#空闲中断程序" class="sidebar-link">空闲中断程序</a></li><li class="sidebar-sub-header"><a href="/pages/a4ea7f/#此外" class="sidebar-link">此外</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/a4ea7f/#参考" class="sidebar-link">参考</a></li></ul></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-33863c7e><div class="articleInfo" data-v-33863c7e><ul class="breadcrumbs" data-v-33863c7e><li data-v-33863c7e><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-33863c7e></a></li> <li data-v-33863c7e><span data-v-33863c7e>不可见</span></li> <!----> <!----></ul> <div class="info" data-v-33863c7e><!----> <div title="创建时间" class="date iconfont icon-riqi" data-v-33863c7e><a href="javascript:;" data-v-33863c7e>2020-08-29</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">
          串口收发
        </h1> <!----> <div class="theme-vdoing-content content__default"><h2 id="什么是串口"><a href="#什么是串口" class="header-anchor">#</a> 什么是串口</h2> <p>串口是一种在单片机，传感器，执行模块等诸多设备上常用的通讯接口，在比赛中，可以通过串口读取遥控器发送来的数据，也可以通过串口读取超声波等传感器的数据，也可以使用串口在单片机和运行计算机视觉的电脑之间进行通讯</p> <p>在此章节中，我们将只讨论异步通信 UART，不需要对外提供时钟输出</p> <h2 id="串口的工作"><a href="#串口的工作" class="header-anchor">#</a> 串口的工作</h2> <h3 id="接收信号的形式"><a href="#接收信号的形式" class="header-anchor">#</a> 接收信号的形式</h3> <p>虽然串口通讯有很多协议，但是经过解码后最终物理传输形式还是 TTL 电平，也就是通过高低电位表示0与1，所以在单片机与 PC 通讯时，需要一个 USB to TTL 的转换器</p> <p>串口的通讯协议由开始位，数据位，校验位，结束位构成。一般以一个<strong>低电平作为一帧数据的起始</strong>，接着跟随8位或者9位<strong>数据位</strong>，之后为<strong>校验位</strong>，分为奇校验，偶校验和无校验，最后以一个先高后低的脉冲表示<strong>结束位</strong>，长度可以设置为0.5，1，1.5或2位长度，只要双方约定一致即可</p> <p>奇偶校验位的原理是统计发送数据中高电平即<code>1</code>数量的奇偶，将结果记录在奇偶校验位中发送给接收方，接收方收到奇偶校验位后和自己收到的数据进行对比，如果奇偶性一致就接受这帧数据，否则认为这帧数据出错</p> <div align="center"><img src="https://cdn.jsdelivr.net/gh/CHANShu0508/images_shack/images/20200829225308.jpg"></div> <table><thead><tr><th>数据帧内容</th> <th>长度</th> <th>功能</th></tr></thead> <tbody><tr><td>起始位</td> <td>1位</td> <td>标志 帧 的开始</td></tr> <tr><td>数据位</td> <td>8或9位</td> <td>传输的数据</td></tr> <tr><td>奇偶校验位</td> <td>1位奇校验/偶校验，或无校验位</td> <td>校验本帧是否正确</td></tr> <tr><td>停止位</td> <td>0.5、1、1.5或2位</td> <td>标志 帧 的结束</td></tr></tbody></table> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>一个传输的“帧”就是一次信号的传输，包括开始位，数据位，校验位，结束位，可能就是传输了一个字节 8 bit 的内容</p></div> <h3 id="波特率"><a href="#波特率" class="header-anchor">#</a> 波特率</h3> <p>一般进行串口通讯时，收发双方要保证遵守同样的协议才能正确的完成收发，除了协议要一致之外，还有一个非常重要的要素要保持一致，那就是<strong>通讯的速率</strong>，即<strong>波特率</strong>。波特率是指发送数据的速率，单位为波特每秒，一般串口常用的波特率有<code>115200</code>，<code>38400</code>，<code>9600</code>等。串口的波特率和总线时钟周期（clock）成倒数关系，即总线时钟周期越短，单位时间内发送的码元数量越多，串口波特率就越高</p> <p>波特率一般有双方约定，但是将程序写入设定的波特率后，储存在寄存器中表示速率的数字却不是这个数字。因为存储这个值的寄存器，只是有16 bit 空间留给存储速率。所以算法是这样：</p> <p>首先需要明确串口所在的总线的外设时钟频率<code>fPCLKx</code>。我们需要知道的是，在串口的 <code>USART_BRR</code>寄存器上的一个16 bit 的值<code>USARTDIV</code>前12 bit 存储着一个数值的整数部分，后4 bit 则是其小数部分</p> <div class="custom-block tip"><p class="custom-block-title">`USARTDIV`的16 bit分配</p> <p>前12 bit 是这个数的整数部分，也就是3位16进制数的范围</p> <p>而后4 bit的表示方法是：将数字的小数部分乘16，随后向下取整，由于这个数一定小于16，所以1位16进制数是完全够用的</p></div> <p>所以公式就是：</p> <p></p><p><mjx-container jax="SVG" display="true" class="MathJax"><svg xmlns="http://www.w3.org/2000/svg" width="25.367ex" height="4.726ex" viewBox="0 -1381 11212.2 2089" style="vertical-align:-1.602ex;"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="math"><g data-mml-node="mo"><text data-variant="normal" transform="matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">波</text><text data-variant="normal" transform="translate(600, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">特</text><text data-variant="normal" transform="translate(1200, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">率</text><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z" transform="translate(1800, 0)"></path></g><g data-mml-node="mfrac" transform="translate(2855.8, 0)"><g data-mml-node="mrow" transform="translate(2119.2, 676)"><g data-mml-node="mi"><path data-c="66" d="M118 -162Q120 -162 124 -164T135 -167T147 -168Q160 -168 171 -155T187 -126Q197 -99 221 27T267 267T289 382V385H242Q195 385 192 387Q188 390 188 397L195 425Q197 430 203 430T250 431Q298 431 298 432Q298 434 307 482T319 540Q356 705 465 705Q502 703 526 683T550 630Q550 594 529 578T487 561Q443 561 443 603Q443 622 454 636T478 657L487 662Q471 668 457 668Q445 668 434 658T419 630Q412 601 403 552T387 469T380 433Q380 431 435 431Q480 431 487 430T498 424Q499 420 496 407T491 391Q489 386 482 386T428 385H372L349 263Q301 15 282 -47Q255 -132 212 -173Q175 -205 139 -205Q107 -205 81 -186T55 -132Q55 -95 76 -78T118 -61Q162 -61 162 -103Q162 -122 151 -136T127 -157L118 -162Z"></path></g><g data-mml-node="mi" transform="translate(550, 0)"><path data-c="50" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path></g><g data-mml-node="mi" transform="translate(1301, 0)"><path data-c="43" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q484 659 454 652T382 628T299 572T226 479Q194 422 175 346T156 222Q156 108 232 58Q280 24 350 24Q441 24 512 92T606 240Q610 253 612 255T628 257Q648 257 648 248Q648 243 647 239Q618 132 523 55T319 -22Q206 -22 128 53T50 252Z"></path></g><g data-mml-node="mi" transform="translate(2016, 0)"><path data-c="4C" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 217 683Q271 680 344 680Q485 680 506 683H518Q524 677 524 674T522 656Q517 641 513 637H475Q406 636 394 628Q387 624 380 600T313 336Q297 271 279 198T252 88L243 52Q243 48 252 48T311 46H328Q360 46 379 47T428 54T478 72T522 106T564 161Q580 191 594 228T611 270Q616 273 628 273H641Q647 264 647 262T627 203T583 83T557 9Q555 4 553 3T537 0T494 -1Q483 -1 418 -1T294 0H116Q32 0 32 10Q32 17 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"></path></g><g data-mml-node="mi" transform="translate(2697, 0)"><path data-c="4B" d="M285 628Q285 635 228 637Q205 637 198 638T191 647Q191 649 193 661Q199 681 203 682Q205 683 214 683H219Q260 681 355 681Q389 681 418 681T463 682T483 682Q500 682 500 674Q500 669 497 660Q496 658 496 654T495 648T493 644T490 641T486 639T479 638T470 637T456 637Q416 636 405 634T387 623L306 305Q307 305 490 449T678 597Q692 611 692 620Q692 635 667 637Q651 637 651 648Q651 650 654 662T659 677Q662 682 676 682Q680 682 711 681T791 680Q814 680 839 681T869 682Q889 682 889 672Q889 650 881 642Q878 637 862 637Q787 632 726 586Q710 576 656 534T556 455L509 418L518 396Q527 374 546 329T581 244Q656 67 661 61Q663 59 666 57Q680 47 717 46H738Q744 38 744 37T741 19Q737 6 731 0H720Q680 3 625 3Q503 3 488 0H478Q472 6 472 9T474 27Q478 40 480 43T491 46H494Q544 46 544 71Q544 75 517 141T485 216L427 354L359 301L291 248L268 155Q245 63 245 58Q245 51 253 49T303 46H334Q340 37 340 35Q340 19 333 5Q328 0 317 0Q314 0 280 1T180 2Q118 2 85 2T49 1Q31 1 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Z"></path></g><g data-mml-node="mi" transform="translate(3546, 0)"><path data-c="78" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path></g></g><g data-mml-node="mrow" transform="translate(220, -686)"><g data-mml-node="mn"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path data-c="36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z" transform="translate(500, 0)"></path></g><g data-mml-node="mo" transform="translate(1222.2, 0)"><path data-c="D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path></g><g data-mml-node="mi" transform="translate(2222.4, 0)"><path data-c="55" d="M107 637Q73 637 71 641Q70 643 70 649Q70 673 81 682Q83 683 98 683Q139 681 234 681Q268 681 297 681T342 682T362 682Q378 682 378 672Q378 670 376 658Q371 641 366 638H364Q362 638 359 638T352 638T343 637T334 637Q295 636 284 634T266 623Q265 621 238 518T184 302T154 169Q152 155 152 140Q152 86 183 55T269 24Q336 24 403 69T501 205L552 406Q599 598 599 606Q599 633 535 637Q511 637 511 648Q511 650 513 660Q517 676 519 679T529 683Q532 683 561 682T645 680Q696 680 723 681T752 682Q767 682 767 672Q767 650 759 642Q756 637 737 637Q666 633 648 597Q646 592 598 404Q557 235 548 205Q515 105 433 42T263 -22Q171 -22 116 34T60 167V183Q60 201 115 421Q164 622 164 628Q164 635 107 637Z"></path></g><g data-mml-node="mi" transform="translate(2989.4, 0)"><path data-c="53" d="M308 24Q367 24 416 76T466 197Q466 260 414 284Q308 311 278 321T236 341Q176 383 176 462Q176 523 208 573T273 648Q302 673 343 688T407 704H418H425Q521 704 564 640Q565 640 577 653T603 682T623 704Q624 704 627 704T632 705Q645 705 645 698T617 577T585 459T569 456Q549 456 549 465Q549 471 550 475Q550 478 551 494T553 520Q553 554 544 579T526 616T501 641Q465 662 419 662Q362 662 313 616T263 510Q263 480 278 458T319 427Q323 425 389 408T456 390Q490 379 522 342T554 242Q554 216 546 186Q541 164 528 137T492 78T426 18T332 -20Q320 -22 298 -22Q199 -22 144 33L134 44L106 13Q83 -14 78 -18T65 -22Q52 -22 52 -14Q52 -11 110 221Q112 227 130 227H143Q149 221 149 216Q149 214 148 207T144 186T142 153Q144 114 160 87T203 47T255 29T308 24Z"></path></g><g data-mml-node="mi" transform="translate(3602.4, 0)"><path data-c="41" d="M208 74Q208 50 254 46Q272 46 272 35Q272 34 270 22Q267 8 264 4T251 0Q249 0 239 0T205 1T141 2Q70 2 50 0H42Q35 7 35 11Q37 38 48 46H62Q132 49 164 96Q170 102 345 401T523 704Q530 716 547 716H555H572Q578 707 578 706L606 383Q634 60 636 57Q641 46 701 46Q726 46 726 36Q726 34 723 22Q720 7 718 4T704 0Q701 0 690 0T651 1T578 2Q484 2 455 0H443Q437 6 437 9T439 27Q443 40 445 43L449 46H469Q523 49 533 63L521 213H283L249 155Q208 86 208 74ZM516 260Q516 271 504 416T490 562L463 519Q447 492 400 412L310 260L413 259Q516 259 516 260Z"></path></g><g data-mml-node="mi" transform="translate(4352.4, 0)"><path data-c="52" d="M230 637Q203 637 198 638T193 649Q193 676 204 682Q206 683 378 683Q550 682 564 680Q620 672 658 652T712 606T733 563T739 529Q739 484 710 445T643 385T576 351T538 338L545 333Q612 295 612 223Q612 212 607 162T602 80V71Q602 53 603 43T614 25T640 16Q668 16 686 38T712 85Q717 99 720 102T735 105Q755 105 755 93Q755 75 731 36Q693 -21 641 -21H632Q571 -21 531 4T487 82Q487 109 502 166T517 239Q517 290 474 313Q459 320 449 321T378 323H309L277 193Q244 61 244 59Q244 55 245 54T252 50T269 48T302 46H333Q339 38 339 37T336 19Q332 6 326 0H311Q275 2 180 2Q146 2 117 2T71 2T50 1Q33 1 33 10Q33 12 36 24Q41 43 46 45Q50 46 61 46H67Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628Q287 635 230 637ZM630 554Q630 586 609 608T523 636Q521 636 500 636T462 637H440Q393 637 386 627Q385 624 352 494T319 361Q319 360 388 360Q466 361 492 367Q556 377 592 426Q608 449 619 486T630 554Z"></path></g><g data-mml-node="mi" transform="translate(5111.4, 0)"><path data-c="54" d="M40 437Q21 437 21 445Q21 450 37 501T71 602L88 651Q93 669 101 677H569H659Q691 677 697 676T704 667Q704 661 687 553T668 444Q668 437 649 437Q640 437 637 437T631 442L629 445Q629 451 635 490T641 551Q641 586 628 604T573 629Q568 630 515 631Q469 631 457 630T439 622Q438 621 368 343T298 60Q298 48 386 46Q418 46 427 45T436 36Q436 31 433 22Q429 4 424 1L422 0Q419 0 415 0Q410 0 363 1T228 2Q99 2 64 0H49Q43 6 43 9T45 27Q49 40 55 46H83H94Q174 46 189 55Q190 56 191 56Q196 59 201 76T241 233Q258 301 269 344Q339 619 339 625Q339 630 310 630H279Q212 630 191 624Q146 614 121 583T67 467Q60 445 57 441T43 437H40Z"></path></g><g data-mml-node="mi" transform="translate(5815.4, 0)"><path data-c="44" d="M287 628Q287 635 230 637Q207 637 200 638T193 647Q193 655 197 667T204 682Q206 683 403 683Q570 682 590 682T630 676Q702 659 752 597T803 431Q803 275 696 151T444 3L430 1L236 0H125H72Q48 0 41 2T33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM703 469Q703 507 692 537T666 584T629 613T590 629T555 636Q553 636 541 636T512 636T479 637H436Q392 637 386 627Q384 623 313 339T242 52Q242 48 253 48T330 47Q335 47 349 47T373 46Q499 46 581 128Q617 164 640 212T683 339T703 469Z"></path></g><g data-mml-node="mi" transform="translate(6643.4, 0)"><path data-c="49" d="M43 1Q26 1 26 10Q26 12 29 24Q34 43 39 45Q42 46 54 46H60Q120 46 136 53Q137 53 138 54Q143 56 149 77T198 273Q210 318 216 344Q286 624 286 626Q284 630 284 631Q274 637 213 637H193Q184 643 189 662Q193 677 195 680T209 683H213Q285 681 359 681Q481 681 487 683H497Q504 676 504 672T501 655T494 639Q491 637 471 637Q440 637 407 634Q393 631 388 623Q381 609 337 432Q326 385 315 341Q245 65 245 59Q245 52 255 50T307 46H339Q345 38 345 37T342 19Q338 6 332 0H316Q279 2 179 2Q143 2 113 2T65 2T43 1Z"></path></g><g data-mml-node="mi" transform="translate(7147.4, 0)"><path data-c="56" d="M52 648Q52 670 65 683H76Q118 680 181 680Q299 680 320 683H330Q336 677 336 674T334 656Q329 641 325 637H304Q282 635 274 635Q245 630 242 620Q242 618 271 369T301 118L374 235Q447 352 520 471T595 594Q599 601 599 609Q599 633 555 637Q537 637 537 648Q537 649 539 661Q542 675 545 679T558 683Q560 683 570 683T604 682T668 681Q737 681 755 683H762Q769 676 769 672Q769 655 760 640Q757 637 743 637Q730 636 719 635T698 630T682 623T670 615T660 608T652 599T645 592L452 282Q272 -9 266 -16Q263 -18 259 -21L241 -22H234Q216 -22 216 -15Q213 -9 177 305Q139 623 138 626Q133 637 76 637H59Q52 642 52 648Z"></path></g></g><rect width="8116.4" height="60" x="120" y="220"></rect></g></g></g></svg></mjx-container></p><p></p> <p>由于采取了一些近似手段，所以通过寄存器产生的波特率和最终期望的波特率之间是<strong>存在误差的</strong>，一般较小的误差不会影响最终的串口通讯，但是如果通讯时出现问题的话，要记得检查是否与通讯速率的实际值与理想值相差较大有关</p> <h2 id="硬件层面"><a href="#硬件层面" class="header-anchor">#</a> 硬件层面</h2> <p>我们从 HAL 库的句柄结构体入手：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
USART_TypeDef <span class="token operator">*</span>Instance<span class="token punctuation">;</span> <span class="token comment">//UART 寄存器基地址</span>
UART_InitTypeDef Init<span class="token punctuation">;</span> <span class="token comment">//UART 通信参数</span>
<span class="token class-name">uint8_t</span> <span class="token operator">*</span>pTxBuffPtr<span class="token punctuation">;</span> <span class="token comment">//指向UART 发送缓冲区</span>
<span class="token class-name">uint16_t</span> TxXferSize<span class="token punctuation">;</span> <span class="token comment">//UART 发送数据大小</span>
__IO <span class="token class-name">uint16_t</span> TxXferCount<span class="token punctuation">;</span> <span class="token comment">//UART 发送计数器</span>
<span class="token class-name">uint8_t</span> <span class="token operator">*</span>pRxBuffPtr<span class="token punctuation">;</span> <span class="token comment">//指向UART 接收缓冲区</span>
<span class="token class-name">uint16_t</span> RxXferSize<span class="token punctuation">;</span> <span class="token comment">//UART 接收数据大小</span>
__IO <span class="token class-name">uint16_t</span> RxXferCount<span class="token punctuation">;</span> <span class="token comment">//UART 接收计数器</span>
DMA_HandleTypeDef <span class="token operator">*</span>hdmatx<span class="token punctuation">;</span> <span class="token comment">//UART 发送参数设置（DMA 模式）</span>
DMA_HandleTypeDef <span class="token operator">*</span>hdmarx<span class="token punctuation">;</span> <span class="token comment">//UART 接收参数设置（DMA 模式）</span>
HAL_LockTypeDef Lock<span class="token punctuation">;</span> <span class="token comment">//锁定对象</span>
__IO HAL_UART_StateTypeDef gState<span class="token punctuation">;</span> <span class="token comment">//UART 全局状态信息并关联发送操作</span>
__IO HAL_UART_StateTypeDef RxState<span class="token punctuation">;</span> <span class="token comment">//UART 接收操作状态信息</span>
__IO <span class="token class-name">uint32_t</span> ErrorCode<span class="token punctuation">;</span> <span class="token comment">//错误代码</span>
<span class="token punctuation">}</span> UART_HandleTypeDef<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>只重点讲到第一个：<code>*Instance</code> 也就是基地址，进入这个结构体之后会有：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span>
<span class="token punctuation">{</span>
  __IO <span class="token class-name">uint32_t</span> SR<span class="token punctuation">;</span>         <span class="token comment">// USART Status register</span>
  __IO <span class="token class-name">uint32_t</span> DR<span class="token punctuation">;</span>         <span class="token comment">// USART Data register</span>
  __IO <span class="token class-name">uint32_t</span> BRR<span class="token punctuation">;</span>        <span class="token comment">// USART Baud rate register</span>
  __IO <span class="token class-name">uint32_t</span> CR1<span class="token punctuation">;</span>        <span class="token comment">// USART Control register 1</span>
  __IO <span class="token class-name">uint32_t</span> CR2<span class="token punctuation">;</span>        <span class="token comment">// USART Control register 2</span>
  __IO <span class="token class-name">uint32_t</span> CR3<span class="token punctuation">;</span>        <span class="token comment">// USART Control register 3</span>
  __IO <span class="token class-name">uint32_t</span> GTPR<span class="token punctuation">;</span>       <span class="token comment">// USART Guard time and prescaler register</span>
<span class="token punctuation">}</span> USART_TypeDef<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><blockquote><p>USART 数据寄存器（USART_DR）只有低 9 位有效，并且第 9 位数据是否有效取决于 USART 控制寄存 1（USART_CR1）的 M 位设置，当 M 位为 0 时表示 8
位数据字长，当 M 位为 1 表示 9 位数据字长，我们一般使用 8 位数据字长。</p> <p>USART_DR 包含了已发送的数据或者接收到的数据。USART_DR 实际是包含了两个寄存器，一个专门用于发送的可写 TDR，另一个专门用于接收的可读 RDR。
当需要发送数据时，内核或 DMA 外设会把数据从内存写入到发送数据寄存器 TDR。因为 TDR 和 RDR 都是介于系统总线和移位寄存器之间，发送时，TDR 的数据转移到发送移位寄存器，然后从移位寄存器一位一位地发送出去。
接收数据就是一个逆过程，数据一位一位地输入接收移位寄存器，然后转移到RDR，最后使用内核指令或 DMA 读取到内存中</p></blockquote> <p>随后，HAL  库还有一个外设的初始化结构体：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
<span class="token class-name">uint32_t</span> BaudRate<span class="token punctuation">;</span> <span class="token comment">//波特率</span>
<span class="token class-name">uint32_t</span> WordLength<span class="token punctuation">;</span> <span class="token comment">//字长</span>
<span class="token class-name">uint32_t</span> StopBits<span class="token punctuation">;</span> <span class="token comment">//停止位</span>
<span class="token class-name">uint32_t</span> Parity<span class="token punctuation">;</span> <span class="token comment">//校验位</span>
<span class="token class-name">uint32_t</span> Mode<span class="token punctuation">;</span> <span class="token comment">//USART 模式</span>
<span class="token class-name">uint32_t</span> HwFlowCtl<span class="token punctuation">;</span> <span class="token comment">//硬件流控制</span>
<span class="token class-name">uint32_t</span> OverSampling<span class="token punctuation">;</span> <span class="token comment">//过采样</span>
<span class="token punctuation">}</span> UART_InitTypeDef<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>详细内容请参考书籍</p> <h2 id="实践操作"><a href="#实践操作" class="header-anchor">#</a> 实践操作</h2> <h3 id="cubemx"><a href="#cubemx" class="header-anchor">#</a> CubeMX</h3> <p>首先，配置 USART，打开此标签，将<code>USART1</code>设为<code>Asynchronous</code>异步通信：</p> <div align="center"><img src="https://cdn.jsdelivr.net/gh/CHANShu0508/images_shack/images/20200829232443.png"></div> <p>随后，将此串口的配置改为：波特率为115200，数据帧设置为8位数据位，无校验位，1位停止位</p> <div align="center"><img src="https://cdn.jsdelivr.net/gh/CHANShu0508/images_shack/images/20200829232638.png"></div> <p>需要注意的是，这些设置也都是初值，在程序中可以通过修改设置这些的结构体来改变这些值。</p> <p>最后在 NVIC 中使能<code>USART1</code>的中断：</p> <div align="center"><img src="https://cdn.jsdelivr.net/gh/CHANShu0508/images_shack/images/20200829232757.png"></div> <p>最后配置你想要的其他以及将时钟改为最高速率即可</p> <h3 id="接收中断与空闲中断"><a href="#接收中断与空闲中断" class="header-anchor">#</a> 接收中断与空闲中断</h3> <p>这两种中断只是串口状态能引发的中断条件之二</p> <table><thead><tr><th></th> <th>接收中断</th> <th>空闲中断</th></tr></thead> <tbody><tr><td>处理函数</td> <td><code>USARTx_IRQHandler</code></td> <td><code>USARTx_IRQHandler</code></td></tr> <tr><td>回调函数</td> <td><code>HAL_UART_RxCpltCallback</code></td> <td>HAL库没有提供</td></tr> <tr><td>USART状态寄存器中的位</td> <td><code>UART_FLAG_RXNE</code></td> <td><code>UART_FLAG_IDLE</code></td></tr> <tr><td>触发条件</td> <td>完成一次数据的接收之后触发一次中断</td> <td>串口接收完一个字符串的数据后又过了一个字节的时间没有接收到任何数据</td></tr></tbody></table> <p>关系是这样：每当串口完成一次接收（传输完<code>HAL_UART_Receive_IT</code>约定长度的内容）之后触发一次中断，这就是串口中断。STM32中相应的中断处理函数为<code>USARTx_IRQHandler</code>，在这个函数中会调用函数<code>HAL_UART_IRQHandler</code>去完成一中断的系列配置工作以及判断中断类型（不包括空闲中断），随后转入回调函数<code>HAL_UART_RxCpltCallback</code>完成中断内容</p> <p>可以通过USART状态寄存器中的<code>UART_FLAG_RXNE</code>位判断 USART 是否发生了接收中断；也可以通过USART状态寄存器中的<code>UART_FLAG_IDLE</code>判断是否发生了空闲中断。接收中断是接受一个帧后引发的中断。</p> <p>而<strong>空闲中断</strong>可以这样解释：在传输内容基本结束后，就不会再有数据传输了，所以在此后的一个字节时间内串口没有接收到信号，自动转入空闲中断。当然这是在开启空闲中断的基础上的，在有数据传输的时候，<code>UART_FLAG_RXNE</code>为1，而<code>UART_FLAG_IDLE</code>为0，在一个字节时间内串口没有接收到信号时，<code>UART_FLAG_IDLE</code>会自动置1，进入空闲中断，进行操作可以在这里对刚刚接收到的字符串进行规整。所以这对<strong>不定长度的信息</strong>接受及其有用</p> <div class="custom-block warning"><p class="custom-block-title">注意</p> <p>你可能会担心空闲中断会不会在串口“空闲”的时候一直发生，实际上是多虑的。因为当清除<code>UART_FLAG_IDLE</code>标志位后，必须有接收到第一个数据后，才开始触发</p></div> <h3 id="用到的库函数"><a href="#用到的库函数" class="header-anchor">#</a> 用到的库函数</h3> <table><thead><tr><th>函数名(宏定义)</th> <th>作用</th> <th>详情</th></tr></thead> <tbody><tr><td>HAL_UART_Transmit</td> <td>从指定的串口发送一段数据</td> <td><a href="/pages/67ee08/#hal-uart-transmit">点击这里</a></td></tr> <tr><td>HAL_UART_RxCpltCallback</td> <td>接收中断的回调函数</td> <td><a href="/pages/67ee08/#hal-uart-txcpltcallback">点击这里</a></td></tr> <tr><td>HAL_UART_Receive_IT</td> <td>开启接收中断的函数</td> <td><a href="/pages/67ee08/#hal-uart-recive-it">点击这里</a></td></tr> <tr><td>__HAL_UART_ENABLE_IT</td> <td>使能某个串口的某种中断类型</td> <td><a href="/pages/67ee08/#hal-uart-enable-it">点击这里</a></td></tr> <tr><td>__HAL_UART_GET_FLAG</td> <td>读取某串口的某寄存器状态位，判断是触发哪个中断的宏定义</td> <td><a href="/pages/67ee08/#hal-uart-get-flag">点击这里</a></td></tr> <tr><td>__HAL_UART_CLEAR_IDLEFLAG</td> <td>清除<code>IDLE</code>的中断标志位的宏定义</td> <td><a href="/pages/67ee08/#hal-uart-clear-idleflag">点击这里</a></td></tr></tbody></table> <h3 id="接收中断程序"><a href="#接收中断程序" class="header-anchor">#</a> 接收中断程序</h3> <p>对于接收中断，HAL 库有一套完整的封装好的处理流程，也就是上面提到的过程，调用回调函数。他能做到的就是接收一个帧后触发中断，处理，回调。在这个回调中将会自动清楚中断标志位等。需要区分的一点是，上面有两个库函数(宏定义)：</p> <ul><li><p><code>HAL_UART_Receive_IT</code>，这个函数一定要在主循环之前手动打开，或者写进 USART 的初始化函数中去。但是在发生了一次中断后，这个函数将会失效，所以你需要在中断回调函数中手动再次打开这个函数才能有下一次中断。</p> <p>这个函数有一个重要的参数，其最后一个参数<code>uint16_t Size</code>表示一次性接收数据的字节长度，只有当这个函数把这些个字节长度都接收到缓存区中之后才会触发中断、回调。它的机制就是在这个函数中有一个接收计数器，每当这个函数接收一个字节的数据就会减一，当它的值减为0后，就先清除中断标记，随后产生中断</p></li> <li><p><code>__HAL_UART_ENABLE_IT</code>，它被上面的那个函数调用开启了串口的接收中断，也就是利用它<code>HAL_UART_Receive_IT</code>才能使能一次接收中断</p></li></ul> <p>详情请参考<a href="https://www.itread01.com/content/1537969219.html" target="_blank" rel="noopener noreferrer">这篇文章<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>与<a href="https://www.jianshu.com/p/471efa40a23b" target="_blank" rel="noopener noreferrer">这篇文章<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="空闲中断程序"><a href="#空闲中断程序" class="header-anchor">#</a> 空闲中断程序</h3> <p>对于空闲中断，则 HAL 库没有提供中断的回调函数以及使能的函数，所以这些操作需要我们自己设置：</p> <ul><li><p>首先需要使能空闲中断：使用<code>__HAL_UART_ENABLE_IT</code>去使能空闲中断，你可以选择去<code>stm32f4xx_hal_uart.c</code>文件的<code>HAL_UART_Init()</code>这个初始化函数中添加这个内容，或者在<code>while(1)</code>之前添加均可</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/*Enable the IDLE Interrupt*/</span>
<span class="token function">__HAL_UART_ENABLE_IT</span><span class="token punctuation">(</span>huart<span class="token punctuation">,</span>UART_IT_IDLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li> <li><p>然后在<code>stm32f4xx_it.c</code>中向对应的串口中断服务函数中添加判断是否为空闲中断，若是空闲中断则进入空闲中断处理函数，空闲中断处理函数是自己写的</p> <p>由于受串口诱发的中断都会由硬件转入<code>USARTx_IRQHandler</code>，这个函数调用<code>HAL_UART_IRQHandler</code>判断中断类型（发送中断还是接收中断）来决定调用哪个函数，若是接收中断则调用<code>UART_Receive_IT</code>(不是<code>HAL_UART_Receive_IT</code>)，这个函数再调用回调函数</p> <p>模仿这个逻辑，我们在<code>USARTx_IRQHandler</code>这里的时候就加一步判断：是否为空闲中断？是则转入我们自己写的回调函数，若不是则按其自己的程序运行：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/* file `stm32f4xx_it.c` */</span>
<span class="token keyword">void</span> <span class="token function">USART1_IRQHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token comment">/* USER CODE BEGIN USART1_IRQn 0 */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__HAL_UART_GET_FLAG</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">,</span> UART_FLAG_IDLE<span class="token punctuation">)</span> <span class="token operator">!=</span> RESET<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">UART_IDLECallBack</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
	<span class="token comment">/* USER CODE END USART1_IRQn 0 */</span>
	<span class="token function">HAL_UART_IRQHandler</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/* USER CODE BEGIN USART1_IRQn 1 */</span>
    <span class="token punctuation">}</span>
	<span class="token comment">/* USER CODE END USART1_IRQn 1 */</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>判断的位置除了这么用还可以使用<code>huart1.Instance-&gt;SR &amp; UART_FLAG_IDLE</code>这样的直接访问寄存器读取状态后，使用与运算得到</p> <p>那在回调时，定义一个自己的回调函数即可：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">UART_IDLECallBack</span><span class="token punctuation">(</span>UART_HandleTypeDef <span class="token operator">*</span>huart<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">/*uart1 idle processing function*/</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>huart <span class="token operator">==</span> <span class="token operator">&amp;</span>huart1<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">__HAL_UART_CLEAR_IDLEFLAG</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/*your own code*/</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div></li> <li><p>在自己写的回调函数中有很重要的一步就是清除空闲中断的标志位。由于没有针对的流程，所以这些操作都需要自己设置</p></li></ul> <p>详细内容参考<a href="https://blog.csdn.net/ruiyelp/article/details/77991098" target="_blank" rel="noopener noreferrer">这篇文章<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>在实验的时候你可以在两种不同的中断状态时设置不同的LED亮起以显示程序是否起了作用</p> <h3 id="此外"><a href="#此外" class="header-anchor">#</a> 此外</h3> <p>在《Robomaster 开发板 C 型教程》中的第八章提供了另一种处理空闲中断的方法，也就是全部改写<code>USARTx_IRQHandler</code>，不让它调用<code>HAL_UART_IRQHandler</code>，而是由我们自己决定。所以配置项会多一点，但是在写出两个中断函数时将会更自由，示例代码地址<a href="https://github.com/RoboMaster/Development-Board-C-Examples/tree/master/8.USART_receive_and_send" target="_blank" rel="noopener noreferrer">点这里<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="参考"><a href="#参考" class="header-anchor">#</a> 参考</h2> <p>[1] 《Robomaster 开发板 C 型教程》</p> <p>[2] <a href="https://blog.csdn.net/geek_monkey/article/details/89165040" target="_blank" rel="noopener noreferrer">HAL库教程6：串口数据接收<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>[3] <a href="https://www.jianshu.com/p/bf6ddc614555" target="_blank" rel="noopener noreferrer">STM32 利用Hal库实现UART中断处理<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>[4] <a href="https://www.bbsmax.com/A/pRdBOjMGzn/" target="_blank" rel="noopener noreferrer">STM32 HAL库笔记（一）——串口的操作<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>[5] <a href="https://blog.csdn.net/as480133937/article/details/105013368" target="_blank" rel="noopener noreferrer">STM32 HAL CubeMX 串口IDLE接收空闲中断+DMA<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>[6] <a href="https://blog.csdn.net/ruiyelp/article/details/77991098" target="_blank" rel="noopener noreferrer">STM32F4的HAL库开启串口空闲中断<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div></div> <!----> <div class="page-edit"><div class="edit-link"><a href="https://github.com/chanshu0508/wikiBase/edit/master/docs/05.不可见/10.串口收发.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2020/10/02, 12:10:00</span></div></div> <div class="page-nav-wapper"><!----> <!----></div></div> <!----></main></div> <div class="footer"><!----> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2020-2021
    <span>Jack :) | MIT License</span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">跟随系统</li><li class="iconfont icon-rijianmoshi">浅色模式</li><li class="iconfont icon-yejianmoshi">深色模式</li><li class="iconfont icon-yuedu">阅读模式</li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.287ba006.js" defer></script><script src="/assets/js/2.cf4362eb.js" defer></script><script src="/assets/js/34.2357e103.js" defer></script>
  </body>
</html>