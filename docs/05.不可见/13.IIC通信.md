> 没有学完：
>
> * 代码与CubeMX都不要参考
> * 代码：<https://www.cnblogs.com/xingboy/p/9647326.html>
> * 原理：<https://www.cnblogs.com/xingboy/p/9585755.html>

## 硬件基础

之前有写到一点关于 I<sup>2</sup>C 的内容，请见[这里](/pages/1c5e9d/#_3-1-i2c-总线)

这里以 RM C 板中磁力计的使用为例。但事实上 I<sup>2</sup>C 能够配置与读取的传感器种类非常多，例如温度传感器，气压传感器，多路ADC模块等

::: tip I<sup>2</sup>C介绍
I<sup>2</sup>C是 PHILIPS 公司开发的一种半双工、双向二线制同步串行总线。两线制代表 I<sup>2</sup>C 只需两根信号线，一根**数据线 SDA**，另一根是**时钟线 SCL**

I<sup>2</sup>C 总线允许挂载多个主设备，但总线时钟同一时刻只能由一个主设备产生，并且要求每个连接到总线上的器件都有唯一的 I<sup>2</sup>C 地址，从设备可以被主设备寻址
:::

I<sup>2</sup>C通信具有几类信号：

* **开始信号S**：当 SCL 处于高电平时，SDA 从高电平拉低至低电平，代表数据传输的开始
* **结束信号P**：当SCL处于高电平时，SDA 从低电平拉高至高电平，代表数据传输结束
* **数据信号**：数据信号每次都传输 8 位数据，每一位数据都在一个时钟周期内传递，当 SCL 处于高电平时候，SDA 数据线上的电平需要稳定，当 SCL 处于**低电平**的时候，SDA 数据线上的电平才允许改变
* **应答信号ACK/NACK**：应答信号是主机发送 8bit 数据，从机对主机发送低电平，表示已经接受数据。

其流程大致如下：

<div align=center><img src="https://cdn.jsdelivr.net/gh/CHANShu0508/images_shack/images/20201003140848.png"/></div>

一个比喻：

> 整个 I2C 通信过程理解成收发快递的过程，**设备 I2C 地址**理解成学校快递柜的地址，**读写位代**表寄出和签收快递，**寄存器地址**则是快递柜上的箱号，而数据便是需要寄出或者签收的快递。整个过程便是如同到学校的快递柜（从机 I2C 地址），对第几号柜箱（寄存器地址），进行寄出或者签收快递（数据）的过程

也就是我们与 I<sup>2</sup>C 设备通信实际上是与设备中的寄存器的通信，通过设备告诉我们的信息找到对应的寄存器地址；如果要读就从那里读取数据，如果要写就从在那个寄存器中写入数据

### 接线

I<sup>2</sup>C 设备的接线一般是三根线：`SCL`, `SDA` 与 `GND`，但是有的也会有 RESET 引脚需要的接线等等其他接线

## CubeMX配置

### 对 GPIO 的设置

<div align=center><img src="https://cdn.jsdelivr.net/gh/CHANShu0508/images_shack/images/20201003144111.png"/></div>

PG3 是 DRDY 线，也就是数据准备的接线，所以配置为外部中断（外部中断引脚常用上拉），下降沿触发，对应“SDA 从高电平拉低至低电平，代表数据传输的开始”

PG6 是 RESET 的接线，配置成 GPIO 的输出模式，上拉模式（一旦输出低电平就复位了）

### IIC 配置

<div align=center><img src="https://cdn.jsdelivr.net/gh/CHANShu0508/images_shack/images/20201003144129.png"/></div>

配置 I2C3 为**快速模式**，**通信频率**设置为 400k，I2C 地址配置成 7 位等等，管脚配置为 PA8，PC9，如图所示
### 其他设置

其他方面的配置请参考前面的文章

## 函数介绍

### 读取函数

```c
HAL_StatusTypeDef HAL_I2C_Mem_Read(I2C_HandleTypeDef *hi2c, 
                                   uint16_t DevAddress, 
                                   uint16_t MemAddress, 
                                   uint16_t MemAddSize, 
                                   uint8_t *pData, 
                                   uint16_t Size, 
                                   uint32_t Timeout)
```

<img src="C:\Users\exzds\AppData\Roaming\Typora\typora-user-images\image-20201003144747729.png" alt="image-20201003144747729" style="zoom:80%;" />

### 写入函数

```c
HAL_StatusTypeDef HAL_I2C_Mem_Write(I2C_HandleTypeDef *hi2c, 
                                    uint16_t DevAddress, 
                                    uint16_t MemAddress, 
                                    uint16_t MemAddSize, 
                                    uint8_t *pData, 
                                    uint16_t Size, 
                                    uint32_t Timeout)
```

<div align=center><img src="https://cdn.jsdelivr.net/gh/CHANShu0508/images_shack/images/20201003145103.png" style="zoom:80%;"/></div>